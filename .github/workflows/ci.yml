name: Build

on:
  pull_request:
    types: [assigned, opened, synchronize, reopened, "ready_for_review"]
    paths-ignore:
      - "apps/examples/**"
      - ".husky/**"
      - ".idea/**"
      - "stories/**"
      - ".vscode/**"
      - "README.md"
      - "CONTRIBUTING.md"
      - "CHANGELOG.md"
      - "LICENSE"

  push:
    branches:
      - main

concurrency:
  group: CI-${{ github.ref }}
  cancel-in-progress: true

env:
  PERCY_TOKEN_PIE_DOCS: ${{ secrets.PERCY_TOKEN_PIE_DOCS }}
  PERCY_TOKEN_PIE_BUTTON: ${{ secrets.PERCY_TOKEN_PIE_BUTTON }}
  PERCY_TOKEN_PIE_ICON_BUTTON: ${{ secrets.PERCY_TOKEN_PIE_ICON_BUTTON }}
  PERCY_TOKEN_PIE_MODAL: ${{ secrets.PERCY_TOKEN_PIE_MODAL }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

jobs:
  dependency-changeset:
    if: github.actor == 'renovate-bot' || github.actor == 'renovate[bot]'
    uses: the-guild-org/shared-config/.github/workflows/changesets-dependencies.yaml@main
    secrets:
      githubToken: ${{ secrets.GITHUB_TOKEN }}

  build-ubuntu-node-18:
    uses: ./.github/workflows/install-build.yml
    with:
      os: ubuntu-latest
      node-version: 18
    secrets: inherit

  deploy-storybook:
    # needs: unit-tests
    uses: ./.github/workflows/amplify-deploy.yml
    with:
      os: ubuntu-latest
      node-version: 18
      amplify-app-id: d17ja0ul7nrdy0
      package-name: 'pie-storybook'
      package-dist-directory: ./apps/pie-storybook/dist
      bucket-name-preview: 'pie-storybook-preview'
      bucket-name-main: 'pie-storybook'
    secrets: inherit
