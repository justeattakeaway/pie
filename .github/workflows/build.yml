name: Build

on:
  pull_request:
    types: [assigned, opened, synchronize, reopened, "ready_for_review"]
    paths-ignore:
      - ".husky/**"
      - ".idea/**"
      - "stories/**"
      - ".vscode/**"
      - "README.md"
      - "CONTRIBUTING.md"
      - "CHANGELOG.md"
      - "LICENSE"
  push:
    branches:
      - main
      - beta-*
      - feature-*

concurrency:
  group: CI-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-changeset:
    if: github.actor == 'renovate-bot' || github.actor == 'renovate[bot]'
    uses: the-guild-org/shared-config/.github/workflows/changesets-dependencies.yaml@main
    secrets:
      githubToken: ${{ secrets.GITHUB_TOKEN }}

  install:
    runs-on: ubuntu-latest
    steps:
      # Checkout the Repo
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node
        # Setup Node 16
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"
      # Restore node_modules if cache exists. If not, cache is created at end of build.
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: "**/node_modules"
          key: node-modules-${{ hashFiles('**/yarn.lock') }}
      # Run 'yarn' if cache doesn't exist. Use --prefer-offline to download packages from yarn cache folder where possible
      - name: Install Dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: yarn add --cached

  build:
    needs: install
    runs-on: ubuntu-latest
    steps:
      # Checkout the Repo
      - name: Checkout
        uses: actions/checkout@v3
      # Setup Node 16
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"
      # Restore node_modules if cache exists. If not, cache is created at end of build.
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: "**/node_modules"
          key: node-modules-${{ hashFiles('**/yarn.lock') }}
      # Lint Styles
      - name: Lint Styles
        run: yarn lint:style --concurrency=10
      # Build Packages
      - name: Build Packages
        run: yarn build
      # Lint JS
      - name: Lint JavaScript
        run: yarn lint:scripts
      # Run Unit Tests
      - name: Unit Tests
        run: yarn test:ci
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

  deploy-docs:
    needs: build
    runs-on: ubuntu-latest
    steps:
      # Checkout the Repo
      - name: Checkout
        uses: actions/checkout@v3
      # Setup Node 16
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"
      # Restore node_modules - Cache should exist as one was created in previous 'install' job
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: "**/node_modules"
          key: node-modules-${{ hashFiles('**/yarn.lock') }}
      # Build Projects
      - name: Build Apps
        run: yarn build --filter=pie-docs
      # Zip dist
      - name: Zip build output
        run: zip -r pie-docs-pr-${{github.event.number}}.zip apps/pie-docs/dist
      # Deployments
      - name: Create GitHub deployment
        if: ${{ github.ref != 'refs/heads/main' }}
        uses: chrnorm/deployment-action@v2
        id: docs-deploy
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: "docs-pr-${{github.event.number}}"
      - name: Upload S3
        uses: shallwefootball/upload-s3-action@v1.2.0
        with:
          aws_key_id: ${{ secrets.AWS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_bucket: ${{ secrets.AWS_DOCS_BUCKET }}
          source_dir: "pie-docs-pr-${{github.event.number}}.zip"
      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment-url: https://d395cqrf1rjsko.cloudfront.net/pr-${{github.event.number}}
          deployment-id: ${{ steps.docs-deploy.outputs.deployment_id }}
          state: "success"
      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment-url: https://d395cqrf1rjsko.cloudfront.net/pr-${{github.event.number}}
          deployment-id: ${{ steps.docs-deploy.outputs.deployment_id }}
          state: "failure"
      - name: Deploy - Master
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ./apps/pie-docs/dist
          force: false
          target-folder: .
          branch: gh-pages
          clean-exclude: |
            ./pr-preview-docs
            ./pr-preview-storybook
            ./storybook
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

  # deploy-storybook:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     # Checkout the Repo
  #     - name: Checkout
  #       uses: actions/checkout@v3
  #     # Setup Node 16
  #     - name: Setup Node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #         cache: "yarn"
  #     # Restore node_modules - Cache should exist as one was created in previous 'install' job
  #     - name: Cache Node Modules
  #       id: cache-node-modules
  #       uses: actions/cache@v3
  #       with:
  #         path: "**/node_modules"
  #         key: node-modules-${{ hashFiles('**/yarn.lock') }}
  #     # Build Projects
  #     - name: Build Apps
  #       run: yarn build --filter=pie-storybook
  #     # Deployments
  #     - name: Create GitHub deployment
  #       uses: chrnorm/deployment-action@v2
  #       id: storybook-deploy
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         environment: "storybook-pr-${{github.event.number}}"
  #     - name: Upload S3
  #       uses: shallwefootball/upload-s3-action@v1.2.0
  #       with:
  #         aws_key_id: ${{ secrets.AWS_KEY_ID }}
  #         aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws_bucket: ${{ secrets.AWS_STORYBOOK_BUCKET }}
  #         source_dir: "./apps/pie-storybook/dist"
  #         destination_dir: "pr-${{github.event.number}}"
  #     - name: Update deployment status (success)
  #       if: success()
  #       uses: chrnorm/deployment-status@v2
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         environment-url: http://${{ secrets.AWS_STORYBOOK_BUCKET }}.s3-website.eu-west-1.amazonaws.com/pr-${{github.event.number}}
  #         deployment-id: ${{ steps.storybook-deploy.outputs.deployment_id }}
  #         state: "success"
  #     - name: Update deployment status (failure)
  #       if: failure()
  #       uses: chrnorm/deployment-status@v2
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         environment-url: http://${{ secrets.AWS_STORYBOOK_BUCKET }}.s3.eu-west-1.amazonaws.com/pr-${{github.event.number}}
  #         deployment-id: ${{ steps.storybook-deploy.outputs.deployment_id }}
  #         state: "failure"
  #     - name: Deploy - Master
  #       if: ${{ github.ref == 'refs/heads/main' }}
  #       uses: JamesIves/github-pages-deploy-action@v4
  #       with:
  #         folder: ./apps/pie-storybook/dist
  #         force: false
  #         branch: gh-pages
  #         target-folder: ./storybook
  #         clean-exclude: |
  #           pr-preview-docs
  #           pr-preview-storybook
  #   env:
  #     TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

  browser-tests:
    needs: deploy-docs
    runs-on: ubuntu-latest
    steps:
      # Checkout the Repo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      # Setup Node 16
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"
      # Restore node_modules - Cache should exist as one was created in previous 'install' job
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: "**/node_modules"
          key: node-modules-${{ hashFiles('**/yarn.lock') }}
      - name: Get installed Playwright version
        id: playwright-version
        run: echo "PLAYWRIGHT_VERSION=`node -p "require('./package.json')['devDependencies']['@playwright/test']"`" >> $GITHUB_ENV
      - name: Cache playwright binaries
        uses: actions/cache@v3
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}
      - run: npx playwright install --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      - run: npx playwright install-deps
      # Run System / a11y Tests
      - name: Run All System / a11y Tests
        run: yarn test:browsers:ci
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: browsers-report
          path: browsers-report/
          retention-days: 7
      # Run Visual Tests
      - name: Run All Visual Tests
        run: yarn test:visual:ci
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: visual-report
          path: visual-report/
          retention-days: 7
    env:
      PERCY_TOKEN_PIE_DOCS: ${{ secrets.PERCY_TOKEN_PIE_DOCS }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

  release:
    needs: build
    if: github.repository == 'justeattakeaway/pie' &&
      ${{ github.event_name != 'pull_request' }} &&
      (contains(github.ref_name, 'main') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'feature'))
    name: release
    runs-on: ubuntu-latest
    steps:
      # Checkout the Repo
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup Node
        # Setup Node 16
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"
      # Restore node_modules - Cache should exist as one was created in previous 'install' job
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: "**/node_modules"
          key: node-modules-${{ hashFiles('**/yarn.lock') }}
      # Run 'yarn' if cache doesn't exist. Use --prefer-offline to download packages from yarn cache folder where possible
      - name: Install Dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: yarn add --cached
      - name: Append NPM token to .npmrc
        run: |
          cat << EOF > "$HOME/.npmrc"
            //registry.npmjs.org/:_authToken=$NPM_TOKEN
          EOF
      # Build Packages
      - name: Build Docs
        if: ${{ github.event_name != 'pull_request' }} &&
          (contains(github.ref_name, 'main') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'feature'))
        run: yarn build
      - name: Check for pre.json file existence
        id: check_files
        uses: andstor/file-existence-action@v2.0.0
        with:
          files: ".changeset/pre.json"
      - name: exit prerelease mode
        # If .changeset/pre.json does not exist and we did not recently exit
        # prerelease mode.
        if: steps.check_files.outputs.files_exists == 'true' && contains(github.ref_name, 'main')
        run: npx changeset pre exit
      - name: Create latest release PR
        if: contains(github.ref_name, 'main')
        uses: changesets/action@v1
        with:
          version: yarn changeset:version
          publish: yarn changeset:publish
          commit: "release: release packages with 'latest' tag"
      # If .changeset/pre.json does not exist and we did not recently exit
      # prerelease mode, enter prerelease mode with tag beta
      - name: Enter beta prerelease mode
        if: steps.check_files.outputs.files_exists == 'false' && contains(github.ref_name, 'beta')
        # If .changeset/pre.json does not exist and we did not recently exit
        # prerelease mode, enter prerelease mode with tag beta
        run: npx changeset pre enter beta
      - name: Create beta release PR
        if: contains(github.ref_name, 'beta')
        uses: changesets/action@v1
        with:
          version: yarn changeset:version
          publish: yarn changeset:publish
          commit: "release: release packages with 'beta' tag"
      - name: Enter feature prerelease mode
        if: steps.check_files.outputs.files_exists == 'false' && contains(github.ref_name, 'feature')
        # If .changeset/pre.json does not exist and we did not recently exit
        # prerelease mode, enter prerelease mode with tag next
        run: npx changeset pre enter next
      - name: Create feature release PR
        if: contains(github.ref_name, 'feature')
        uses: changesets/action@v1
        with:
          version: yarn changeset:version
          publish: yarn changeset:publish
          commit: "release: release packages with 'next' tag"
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      HUSKY: 0
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}