import { Meta } from '@storybook/addon-docs';
import { useMemo } from 'react';
import pieTokensMetadata from '@justeat/pie-design-tokens/metadata/tokensMetadata.json';
import pieDesignTokens from '@justeat/pie-design-tokens/dist/tokens.json';
import { PieTag } from '@justeattakeaway/pie-webc/react/tag.js';

<Meta title="Introduction/Design Tokens" />

# Design Tokens

export const DesignTokensTable = ({ tokenType = 'color', tokenPrefix = '--dt-' }) => {
  
  // Helper function to convert color value with opacity to rgba
  const resolveColorValue = (tokenValue) => {
    if (!tokenValue) return null;
    
    // Check if token has opacity (format: "#hex|opacity")
    if (tokenValue.includes('|')) {
      const [hex, opacity] = tokenValue.split('|');
      let cleanHex = hex.replace('#', '');
      
      // Handle 3-character hex codes by expanding them
      if (cleanHex.length === 3) {
        cleanHex = cleanHex.split('').map(c => c + c).join('');
      }
      
      // Ensure we have a valid 6-character hex
      if (cleanHex.length !== 6) return tokenValue;
      
      const r = parseInt(cleanHex.slice(0, 2), 16);
      const g = parseInt(cleanHex.slice(2, 4), 16);
      const b = parseInt(cleanHex.slice(4, 6), 16);
      return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }
    
    return tokenValue;
  };

  const tokens = useMemo(() => {
    const aliasTokens = pieTokensMetadata[tokenType]?.alias?.default || {};
    const lightThemeValues = pieDesignTokens.theme?.jet?.[tokenType]?.alias?.default || {};
    const darkThemeValues = pieDesignTokens.theme?.jet?.[tokenType]?.alias?.dark || {};
    
    const tokensList = Object.entries(aliasTokens).map(([name, details]) => ({
      name,
      lightValue: lightThemeValues[name],
      darkValue: darkThemeValues[name],
      category: details.category,
      description: details.description,
      status: details.status
    }));
    
    return tokensList;
  }, [tokenType]);
  // Preview renderers for different token types
  const renderColorPreview = (colorValue) => {
    const resolvedColor = resolveColorValue(colorValue);
    if (!resolvedColor) {
      return (
        <div style={{
          width: '40px',
          height: '40px',
          border: '1px solid #ccc',
          borderRadius: '4px',
          backgroundColor: '#f0f0f0',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          fontSize: '10px',
          color: '#666',
          margin: '0 auto'
        }}>
          N/A
        </div>
      );
    }
    
    return (
      <div style={{
        width: '40px',
        height: '40px',
        border: '1px solid #ccc',
        borderRadius: '4px',
        backgroundColor: resolvedColor,
        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
        margin: '0 auto'
      }} title={resolvedColor} />
    );
  };

  const renderElevationPreview = (elevationValue) => {
    if (!elevationValue || !elevationValue.shadows) {
      return <div style={{ margin: '0 auto', fontSize: '10px', color: '#666' }}>N/A</div>;
    }

    const formatShadow = ({ x, y, blur, spread, r, g, b, opacity }) => 
      `${x}px ${y}px ${blur}px ${spread}px rgba(${r}, ${g}, ${b}, ${opacity})`;

    const { shadows = [], insets = [] } = elevationValue;
    const boxShadow = [
      ...shadows.map(formatShadow),
      ...insets.map((inset) => `inset ${formatShadow(inset)}`),
    ].join(', ');

    return (
      <div style={{
        width: '60px',
        height: '60px',
        backgroundColor: '#fff',
        borderRadius: '4px',
        boxShadow,
        margin: '0 auto'
      }} />
    );
  };

  const renderSpacingPreview = (spacingValue) => {
    if (!spacingValue) {
      return <div style={{ margin: '0 auto', fontSize: '10px', color: '#666' }}>N/A</div>;
    }

    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        margin: '0 auto'
      }}>
        <div style={{
          width: `${spacingValue}px`,
          height: '24px',
          backgroundColor: '#FF8000',
          borderRadius: '2px'
        }} />
      </div>
    );
  };

  const renderRadiusPreview = (radiusValue) => {
    if (!radiusValue) {
      return <div style={{ margin: '0 auto', fontSize: '10px', color: '#666' }}>N/A</div>;
    }

    return (
      <div style={{
        width: '40px',
        height: '40px',
        backgroundColor: '#FF8000',
        borderRadius: `${radiusValue}px`,
        margin: '0 auto'
      }} />
    );
  };

  // Map token types to their preview renderers
  const previewRenderers = {
    color: renderColorPreview,
    elevation: renderElevationPreview,
    spacing: renderSpacingPreview,
    radius: renderRadiusPreview
  };

  const renderPreview = previewRenderers[tokenType] || renderColorPreview;
  return (
    <div>
      <table style={{ 
        width: '100%', 
        borderCollapse: 'collapse',
        marginBottom: '20px'
      }}>
        <thead>
          <tr style={{ backgroundColor: '#f5f5f5' }}>
            <th style={{ 
              padding: '12px', 
              textAlign: 'left', 
              borderBottom: '2px solid #ddd',
              fontWeight: '600'
            }}>Token Name</th>
            <th style={{ 
              padding: '12px', 
              textAlign: 'center', 
              borderBottom: '2px solid #ddd',
              fontWeight: '600'
            }}>Light Theme</th>
            <th style={{ 
              padding: '12px', 
              textAlign: 'center', 
              borderBottom: '2px solid #ddd',
              fontWeight: '600'
            }}>Dark Theme</th>
          </tr>
        </thead>
        <tbody>
          {tokens.map((token) => (
            <tr key={token.name} style={{ borderBottom: '1px solid #eee' }}>
              <td style={{ 
                padding: '12px',
                fontFamily: 'monospace',
                fontSize: '14px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span>{tokenPrefix}{tokenType}-{token.name}</span>
                  {token.status?.name === 'deprecated' && (
                    <PieTag 
                      variant="error" 
                      size="small"
                    >
                      Deprecated
                    </PieTag>
                  )}
                </div>
              </td>
              <td style={{ 
                padding: '12px',
                textAlign: 'center'
              }}>
                {renderPreview(token.lightValue)}
              </td>
              <td style={{ 
                padding: '12px',
                textAlign: 'center'
              }}>
                {renderPreview(token.darkValue)}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

## Colours

<DesignTokensTable tokenType="color" />

## Elevation

<DesignTokensTable tokenType="elevation" />

## Spacing

<DesignTokensTable tokenType="spacing" />

## Radius

<DesignTokensTable tokenType="radius" />

## Additional Resources

- [Design Tokens Cookbook](?path=/docs/introduction-design-tokens-cookbook--docs)
- [CSS Variables](?path=/docs/introduction-css-variables--docs)
