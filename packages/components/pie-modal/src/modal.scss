@use '@justeattakeaway/pie-css/scss' as p;
@use '@justeattakeaway/pie-css/scss/settings' as *;
@use 'dialog-polyfill/dist/dialog-polyfill.css';

.c-modal {
    // Custom Property Declarations
    // These are defined here instead of :host to encapsulate them inside Shadow DOM
    --modal-size-s: 450px;
    --modal-size-m: 600px;
    --modal-size-l: 1080px;

    // The base modal defaults
    --modal-border-radius: var(--dt-radius-rounded-d);
    --modal-font: var(--dt-font-interactive-l-family);
    --modal-content-color: var(--dt-color-content-default);
    --modal-bg-color: var(--dt-color-container-default);
    --modal-elevation: var(--dt-elevation-below-20);
    --modal-image-slot-bg-color: none;
    --modal-easing: var(--dt-motion-easing-persistent-functional);
    --modal-duration: var(--dt-motion-timing-150);
    --backdrop-duration: var(--dt-motion-timing-200);

    &:focus-visible {
        outline: none;
    }

    // We need to override the icon sizes at different screen sizes regardless of size prop passed in
    pie-icon-button {
        @include media('<md') {
            --btn-dimension: 40px;
        }
    }

    opacity: 0;
    transform: translateY(-40px);
    transition:
        opacity var(--modal-duration) var(--modal-easing),
        transform var(--modal-duration) var(--modal-easing),
        display var(--modal-duration) allow-discrete,
        overlay var(--backdrop-duration) allow-discrete;


    &[open] {
        --modal-duration: var(--dt-motion-timing-250);
        --backdrop-duration: var(--dt-motion-timing-300);

        opacity: 1;
        transform: translateY(0);

        @starting-style {
            opacity: 0;
            transform: translateY(-40px);
        }

        &::backdrop {
            opacity: 1;
    
            @starting-style {
                opacity: 0;
            }
        }
    }

    position: fixed;
    top: 0;
    border-radius: var(--modal-border-radius);
    border: none;
    box-shadow: var(--modal-elevation);
    font-family: var(--modal-font);
    color: var(--modal-content-color);
    background-color: var(--modal-bg-color);

    padding: 0;

    --modal-margin-none: var(--dt-spacing-none);
    --modal-margin-small: var(--dt-spacing-g);
    --modal-margin-large: var(--dt-spacing-j);
    --modal-margin-block: var(--modal-margin-small);

    @include media('>md') {
        --modal-margin-block: var(--modal-margin-large);
    }

    // The initial values for these variables apply to the medium-sized modal
    // Other sizes will update the variables as needed
    --modal-block-size: fit-content;
    --modal-inline-size: 75%;
    --modal-max-block-size: calc(100vh - calc(var(--modal-margin-block) * 2));
    --modal-max-inline-size: var(--modal-size-m);

    block-size: var(--modal-block-size);
    inline-size: var(--modal-inline-size);
    max-block-size: var(--modal-max-block-size);
    max-inline-size: var(--modal-max-inline-size);

    &.c-modal--small {
        --modal-max-inline-size: var(--modal-size-s);

        @include media('>md') {
            --modal-margin-block: var(--modal-margin-large);
        }
    }

    &.c-modal--medium {
        /* Same as default styles */
    }

    &.c-modal--large {
        --modal-inline-size: 75%;
        --modal-max-inline-size: var(--modal-size-l);
        --modal-margin-block: var(--modal-margin-large);
    }

    // Fullscreen styles
    &.c-modal--large,
    &.c-modal--medium.c-modal--fullWidthBelowMid {
        @include media('<md') {
            --modal-margin-block: var(--modal-margin-none);
            --modal-border-radius: var(--dt-radius-rounded-none);
            --modal-block-size: 100%;
            --modal-inline-size: 100%;

            // In order to be fullscreen, the modal may need to exceed
            // the previous maximum width for a medium modal
            --modal-max-inline-size: 100%;

            // this ensures the content container spans the full height
            > .c-modal-scrollContainer {
                block-size: 100%;
            }
        }
    }

    &.c-modal--top {
        margin-block-start: var(--dt-spacing-j);
        max-block-size: calc(100% - var(--dt-spacing-j) * 2);

        &.c-modal--large,
        &.c-modal--fullWidthBelowMid.c-modal--medium {
            @include media('<md') {
                margin-block-start: var(--dt-spacing-none);
                max-block-size: 100%;
            }
        }
    }

    &::backdrop {
        background: var(--dt-color-overlay);
        opacity: 0;
        transition:
            opacity var(--backdrop-duration) var(--modal-easing),
            display var(--backdrop-duration) allow-discrete,
            overlay var(--backdrop-duration) allow-discrete;
    }

    & .c-modal-closeBtn {
        grid-area: close;
        margin-block-start: var(--dt-spacing-b);
        margin-block-end: var(--dt-spacing-b);
        margin-inline-start: var(--dt-spacing-none);
        margin-inline-end: var(--dt-spacing-b);

        @include media('>md') {
            margin-block-start: var(--dt-spacing-c);
            margin-block-end: var(--dt-spacing-c);
            margin-inline-start: var(--dt-spacing-none);
            margin-inline-end: var(--dt-spacing-c);
        }
    }

    & .c-modal-imageSlot {
        &.c-modal-imageSlot--illustration {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            background-color:var(--modal-image-slot-bg-color);

            ::slotted([slot="image"]) {
                width: 168px;
                height: 168px;
                overflow: hidden;
            }
        }

        &.c-modal-imageSlot--image {
            overflow: hidden;

            // imageSlot--medium = default
            aspect-ratio: 3/1;

            &.c-modal-imageSlot--small {
                aspect-ratio: 4/1;
            }

            &.c-modal-imageSlot--large {
                aspect-ratio: 21/9;
            }

            ::slotted([slot="image"]) {
                width: 100%;
            }
        }

        & .c-modal-closeBtn {
            position: absolute;
            inset-block-start: 0;
            inset-inline-end: 0;

            margin-block-start: var(--dt-spacing-d);
            margin-inline-end:  var(--dt-spacing-d);
        }
    }

    & .c-modal-footer {
        --modal-button-spacing: var(--dt-spacing-d);
        --modal-footer-padding: var(--dt-spacing-d);

        display: flex;
        flex-flow: row-reverse;
        flex-wrap: wrap;
        gap: var(--modal-button-spacing);
        padding: var(--modal-footer-padding);

        @include media('>md') {
            --modal-footer-padding: var(--dt-spacing-e);
        }

        &.c-modal-footer--stackedActions {
            // TODO: Move breakpoint sizes into shared CSS component utilities
            @include media('<md') {
                flex-direction: column;
            }
        }
    }

    ::slotted([slot="footer"]) {
        display: flex;
        width: 100%;
    }

    ::slotted([slot="headerContent"]) {
        grid-area: content;
        padding-inline-start: var(--dt-spacing-e);
        padding-inline-end: var(--dt-spacing-e);
        margin-block-end: var(--dt-spacing-d);
    }

    & .c-modal-header {
        display: grid;
        grid-template-areas:
            'back   heading   close'
            'content content content';
        grid-template-columns: minmax(0, max-content) minmax(0, 1fr) minmax(0, max-content);
        align-items: start;
    }

    & .c-modal-heading {
        --modal-header-font-size: calc(var(--dt-font-heading-m-size--narrow) * 1px);
        --modal-header-font-line-height: calc(var(--dt-font-heading-m-line-height--narrow) * 1px);
        --modal-header-font-weight: var(--dt-font-heading-m-weight);
        --modal-header-font-style: normal;

        font-size: var(--modal-header-font-size);
        line-height: var(--modal-header-font-line-height);
        font-weight: var(--modal-header-font-weight);
        font-style: var(--modal-header-font-style);
        margin: 0;
        grid-area: heading;

        margin-inline-start: var(--dt-spacing-d);
        margin-inline-end: var(--dt-spacing-d);
        margin-block: 16px; // This is deliberately not a custom property

        @include media('>md') {
            --modal-header-font-size: calc(var(--dt-font-heading-m-size--wide) * 1px);
            --modal-header-font-line-height: calc(var(--dt-font-heading-m-line-height--wide) * 1px);
            margin-inline-start: var(--dt-spacing-e);
            margin-inline-end: var(--dt-spacing-e);
            margin-block: 22px; // This is deliberately not a custom property
        }

        &.c-modal-heading--emphasised {
            --modal-header-font-size: calc(var(--dt-font-heading-l-italic-size--narrow) * 1px);
            --modal-header-font-line-height: calc(var(--dt-font-heading-m-italic-line-height--narrow) * 1px);
            --modal-header-font-weight: var(--dt-font-heading-l-italic-weight);
            --modal-header-font-style: var(--dt-font-heading-l-italic-font-style);
            font-variation-settings: "slnt" -20;

            @include media('>md') {
                --modal-header-font-size: calc(var(--dt-font-heading-l-italic-size--wide) * 1px);
                --modal-header-font-line-height: calc(var(--dt-font-heading-l-italic-line-height--wide) * 1px);
            }
        }
    }

    // Ensure correct padding when there is a back button in front of the heading
    .c-modal-backBtn + .c-modal-heading {
        margin-inline-start: var(--dt-spacing-b);

        @include media('>md') {
            margin-inline-start: var(--dt-spacing-c);
        }
    }

    &.c-modal--dismissible .c-modal-heading {
        margin-inline-end: var(--dt-spacing-d);

        @include media('>md') {
            margin-inline-end: var(--dt-spacing-e);
        }
    }

    & .c-modal-backBtn {
        grid-area: back;
        margin-block-start: var(--dt-spacing-b);
        margin-block-end: var(--dt-spacing-b);
        margin-inline-start: var(--dt-spacing-b);
        margin-inline-end: var(--dt-spacing-none);

        @include media('>md') {
            margin-block-start: var(--dt-spacing-c);
            margin-block-end: var(--dt-spacing-c);
            margin-inline-start: var(--dt-spacing-c);
            margin-inline-end: var(--dt-spacing-none);
        }
    }

    & .c-modal-content {
        // Modal content Custom Props
        --modal-content-font-size: calc(var(--dt-font-body-l-size) * 1px);
        --modal-content-font-weight: var(--dt-font-body-l-weight);
        --modal-content-line-height: calc(var(--dt-font-body-l-line-height) * 1px);
        --modal-content-padding-block: var(--dt-spacing-a);
        --modal-content-padding-inline: var(--dt-spacing-d);
        --modal-content-padding-block-end: var(--dt-spacing-e);


        @include media('>md') {
            --modal-content-padding-inline: var(--dt-spacing-e);
        }

        position: relative;

        font-size: var(--modal-content-font-size);
        line-height: var(--modal-content-line-height);
        font-weight: var(--modal-content-font-weight);

        padding-inline-start: var(--modal-content-padding-inline);
        padding-inline-end: var(--modal-content-padding-inline);
        padding-block-start: var(--modal-content-padding-block);
        padding-block-end: var(--modal-content-padding-block-end); // We require a larger bottom padding when there's no footer
        flex-grow: 1;

        &:has(+ slot > footer) {
            padding-block-end: var(--modal-content-padding-block);
        }

        &--scrollable {
            background:
                // Scroll shadow cover
                // A top-to-bottom opacity gradient from transparent to the component background colour
                linear-gradient(to bottom, transparent, var(--dt-color-container-default) 75%) center bottom,
                // Scroll shadow
                linear-gradient(transparent, var(--dt-color-border-strong)) center bottom;
            background-repeat: no-repeat;
            background-size: 100% 48px, 100% 12px;

            // The shadow cover is an opacity gradient which is attached to the bottom of the scrollable element
            // and scrolls with it, so as you reach the bottom of the content the more opaque portion covers
            // (and therefore hides) the shadow. This gives the effect of the shadow fading away.
            // The shadow itself does not move as you scroll.
            background-attachment: local, scroll;
        }
    }

    & > .c-modal-scrollContainer {
        display: flex;
        flex-direction: column;
        overflow-y: auto;

        // These are the shadows used to indicate scrolling above and below content
        --bg-scroll-end: linear-gradient(rgba(255, 255, 255, 0), var(--modal-bg-color) 70%) 0 100%;
        --bg-scroll-bottom: radial-gradient(farthest-corner at 50% 100%, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0)) 0 100%;

        // Sizes of the scroll shadows
        --bg-size-scroll-end: 100% 40px;
        --bg-size-scroll-bottom: 100% 8px;

        background: var(--bg-scroll-end), var(--bg-scroll-bottom);
        background-repeat: no-repeat;
        background-size: var(--bg-size-scroll-end), var(--bg-size-scroll-bottom);

        background-attachment: local, scroll;

        .c-modal-content {
            flex-shrink: 0;
        }
    }

    &.c-modal--pinnedFooter .c-modal-content {
        overflow-y: auto;
    }

    &.c-modal--loading .c-modal-content {
        pie-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--dt-spacing-j) calc(var(--dt-spacing-j) + var(--dt-spacing-d));
        }

        & .c-modal-contentInner {
            display: none;
        }
    }

    // removes the scroll shadow effect if "background-attachment" isn't supported.
    // @supports (background-attachment: local) isn't used as Safari 14 recognizes the property but it has no effect.
    // thus, "aspect-ratio" is used instead as it's only supported in Safari>=15
    @supports not (aspect-ratio: 1 / 1) {
        .c-modal-scrollContainer {
            background: none;
        }
    }

    .c-modal-backBtn-icon:dir(rtl) {
        transform: rotate(180deg);
    }

    // Additional background colors
    &.c-modal--bg-subtle { --modal-image-slot-bg-color: var(--dt-color-container-subtle); }

    &.c-modal--bg-brand-01 { --modal-bg-color: var(--dt-color-support-brand-01); }

    &.c-modal--bg-brand-02 { --modal-bg-color: var(--dt-color-support-brand-02); }

    &.c-modal--bg-brand-03 { --modal-bg-color: var(--dt-color-support-brand-03); }

    &.c-modal--bg-brand-03-subtle { --modal-bg-color: var(--dt-color-support-brand-03-subtle); }

    &.c-modal--bg-brand-04 { --modal-bg-color: var(--dt-color-support-brand-04); }

    &.c-modal--bg-brand-04-subtle { --modal-bg-color: var(--dt-color-support-brand-04-subtle); }

    &.c-modal--bg-brand-05 { --modal-bg-color: var(--dt-color-support-brand-05); }

    &.c-modal--bg-brand-05-subtle { --modal-bg-color: var(--dt-color-support-brand-05-subtle); }

    &.c-modal--bg-brand-06 {
        --modal-content-color: var(--dt-color-content-inverse);
        --modal-bg-color: var(--dt-color-support-brand-06);
    }

    &.c-modal--bg-brand-06-subtle { --modal-bg-color: var(--dt-color-support-brand-06-subtle); }

    &.c-modal--bg-brand-08 { --modal-bg-color: var(--dt-color-support-brand-08); }

    &.c-modal--bg-brand-08-subtle { --modal-bg-color: var(--dt-color-support-brand-08-subtle); }

    @media (prefers-reduced-motion: reduce) {
        &,
        &::backdrop {
          transition: none;
          transform: none;
        }
      }
}
